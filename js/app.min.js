function unique(t,e){var r=t.slice(0);r.sort(function(t,r){return t[e].localeCompare(r[e])});for(var n=1;n<r.length;)r[n-1][e]==r[n][e]?r.splice(n,1):n++;return r}var bannerModule=angular.module("bannerModule",[]),catalogueModule=angular.module("catalogueModule",[]),itemModule=angular.module("itemModule",[]),menuRootModule=angular.module("menuRootModule",[]),cartModule=angular.module("cartModule",[]),checkOutModule=angular.module("checkOutModule",[]),funshopApp=angular.module("funshopApp",["ngAnimate","ngCookies","ui.router","ui.bootstrap","pascalprecht.translate","ngTagsInput","catalogueModule","bannerModule","menuRootModule","cartModule","checkOutModule","itemModule"]);funshopApp.config(["$translateProvider","$translatePartialLoaderProvider",function(t,e){t.registerAvailableLanguageKeys(["en","ru"],{"en_*":"en","ru_*":"ru"}).determinePreferredLanguage().fallbackLanguage("en").useCookieStorage().useLoader("$translatePartialLoader",{urlTemplate:"i18n/{part}/{lang}.json"}).useLoaderCache(!0).useSanitizeValueStrategy("escape"),e.addPart("Banner","MenuRoot","Catalogue")}]),funshopApp.run(["$rootScope","$translate",function(t,e){t.$on("$translatePartialLoaderStructureChanged",function(){e.refresh()})}]),funshopApp.config(["$stateProvider","$urlRouterProvider",function(t,e){e.otherwise("/catalogue"),t.state("catalogue",{url:"/catalogue?category",template:"<cat-menu></cat-menu>"}).state("item",{url:"/catalogue/item?category&item",templateUrl:"templates/itemPage.html",controller:"itemPageCtrl"}).state("about",{url:"/about",templateUrl:"templates/_about.html"}).state("cart",{url:"/cart",template:"<cart-list></cart-list>"}).state("checkOut",{url:"/cart/checkout",template:"<check-out></check-out>"}).state("checkOut.confirm",{url:"/confirm",onEnter:["$stateParams","$state","$uibModal","cartContainer",function(t,e,r,n){r.open({templateUrl:"templates/checkoutModal.html",controller:"checkoutConfirmModalCtrl",controllerAs:"vm",size:"sm",bindToController:!0}).result.then(function(){n.emptyCart(),e.go("catalogue")},function(){e.go("^")})}],onExit:function(){}})}]),bannerModule.directive("mainBanner",["$timeout","$q",function(t,e){var r=["img/bg01.jpg","img/bg02.jpg","img/bg03.jpg"];return{restrict:"E",scope:{},templateUrl:"templates/banner.html",link:function(e,n,a,o){function i(e){t(function(){l++,u.css({"background-image":"url("+r[l-1]+")"}),l>2&&(l=0),i(10101)},e)}e.imgsDefer=[];for(var c=[],u=angular.element(n[0].querySelector(".jumbotron")),l=1,s=0;s<r.length;s++)c[s]=new Image,c[s].src=r[s],c[s].onload=function(t){e.imgsDefer.push("done"),e.imgsDefer.length==r.length&&i(1)}}}}]),cartModule.directive("cartBtn",["$timeout",function(t){var e=["$scope","$translate","$translatePartialLoader","cartContainer",function(t,e,r,n){var a=this;a.productsCount=n.itemCount(),a.isDisabled=function(){return 0==a.productsCount},t.$watch(function(){return n.itemCount()},function(){a.productsCount=n.itemCount()},!0)}];return{restrict:"E",scope:{},controller:e,controllerAs:"vm",bindToController:!0,templateUrl:"templates/cartBtn.html",link:function(e,r,n,a){var o=r.find("button"),i=angular.element(r[0].querySelector(".badge")),c=null,u=o.css("background-color"),l="#5CBA5F",s="#F4A82B",d=function(e,r){c&&(t.cancel(c),c=null),e>r?(o.css({"background-color":l,"border-color":l}),i.css({color:l})):(o.css({"background-color":s,"border-color":s}),i.css({color:s})),c=t(function(){o.css({"background-color":u,"border-color":u}),i.css({color:u})},200)};e.$watch(function(){return e.vm.productsCount},d)}}}]),cartModule.directive("cartListConfirm",["$document",function(t){return{restrict:"A",require:"?ngModel",transclude:!0,template:"<div ng-transclude></div>",link:function(e,r,n,a){e.confirmShow=!1,e.toggleSelect=function(){e.confirmShow=!e.confirmShow},t.bind("click",function(t){var n=angular.element(r[0].contains(t.target)).length>0;n||e.$apply(function(){e.confirmShow=!1})})}}}]),cartModule.directive("cartList",function(){return{restrict:"E",scope:{},controller:"cartListCtrl",controllerAs:"vm",bindToController:!0,templateUrl:"templates/cartList.html"}});var cartListCtrl=function(t,e,r,n,a){var o=this;o.totalCount=a.totalPrice(),o.cartList=a.readItems(),o.removeItemType=function(t){a.removeItemType(t),o.updateCartModel()},o.minusItem=function(t){a.minusItem(t),o.updateCartModel()},o.plusItem=function(t){a.plusItem(t),o.updateCartModel()},o.emptyCart=function(){a.emptyCart(),o.updateCartModel(),t.go("catalogue")},o.updateCartModel=function(){o.totalCount=a.totalPrice(),o.cartList=a.readItems(),o.totalCount<1&&t.go("catalogue")}};cartListCtrl.$inject=["$state","$translate","$translatePartialLoader","productsLoader","cartContainer"],cartModule.controller("cartListCtrl",cartListCtrl),catalogueModule.filter("byRange",function(){return function(t,e,r){var n=[];if(void 0===e||null==e||null===e.min&&null===e.max)return t;if(void 0===e.min||null===e.min){if(0==e.max)return t;for(var a=0;a<t.length;a++)t[a][r]<=e.max&&n.push(t[a]);return n}if(void 0===e.max||null===e.max||0==e.max){for(a=0;a<t.length;a++)t[a][r]>=e.min&&n.push(t[a]);return n}for(a=0;a<t.length;a++)t[a][r]>=e.min&&t[a][r]<=e.max&&n.push(t[a]);return n}}),catalogueModule.filter("byTags",function(){return function(t,e,r){var n=[];if(e){for(var a=0;a<t.length;a++){for(var o=0,i=0;i<e.length;i++)for(var c=0;c<t[a][r].length;c++)t[a][r][c].text==e[i].text&&o++;o==e.length&&n.push(t[a])}return n}return t}}),catalogueModule.filter("myUnique",function(){return function(t,e){if(!t||!e)return!1;for(var r=unique(t,e),n=[],a=0;a<r.length;a++)n.push(r[a]);return n}}),catalogueModule.directive("catContent",function(){var t=["productsLoader","$scope","$filter",function(t,e,r){var n=this;n.loadFinished=!1;var a={setDefaults:function(){this.name="",this.brand="",this.price={min:null,max:null},this.tags=null}};a.setDefaults(),n.search=Object.create(a),e.$watch(function(){return n.requests},function(){n.requests&&(n.loadFinished=!1,t.getJSONProducts(n.requests).then(function(t){n.goodies=t,n.paginator={currentPage:1,maxSize:8,numPerPage:9,totalItems:n.goodies.length},n.updateProds(),n.loadFinished=!0,e.$watch(function(){return[n.search.tags,n.search.price.min,n.search.price.max,n.search.name,n.search.brand]},function(){n.search.price.min<0&&(n.search.price.min=0),n.search.price.max<0&&(n.search.price.max=0),n.updateProds()},!0)}))},!0),n.loadTags=function(t){for(var e=[],r=[],n=0;n<this.goodies.length;n++)e.push.apply(e,this.goodies[n].tags);for(e=unique(e,"text"),n=0;n<e.length;n++)-1!==e[n].text.indexOf(t)&&r.push(e[n]);return r},n.resetFilter=function(){n.search.setDefaults()},n.setOrder=function(t){"alph"==t?e.priceReverse=null:e.alphReverse=null,n.updateProds()},n.updateFilter=function(t,n,a){var o;o=r("filter")(t,{name:n.name,brand:n.brand}),o=r("byRange")(o,n.price,"price"),o=r("byTags")(o,n.tags,"tags"),(e.alphReverse||0==e.alphReverse)&&(o=r("orderBy")(o,"name",e.alphReverse)),(e.priceReverse||0==e.priceReverse)&&(o=r("orderBy")(o,"price",e.priceReverse)),a.totalItems=o.length;var i=(a.currentPage-1)*a.numPerPage,c=i+a.numPerPage;return o=o.slice(i,c)},n.updateProds=function(){n.filteredGoodies=n.updateFilter(n.goodies,n.search,n.paginator)}}];return{restrict:"E",scope:{requests:"=requests",categories:"=categories"},require:"^catMenu",controller:t,controllerAs:"vm",bindToController:!0,templateUrl:"templates/catContent.html"}}),catalogueModule.directive("catMenu",["$window",function(t){var e=["cartContainer","productsLoader","$scope","$state","$stateParams",function(t,e,r,n,a){var o=r;a.category?o.catID=a.category:o.catID="all",e.getJSONCategories().then(function(t){o.categories=t,o.requests=[];for(var e=0;e<t.length;e++)(t[e].id==o.catID||"all"==o.catID)&&o.requests.push(t[e].http_request);o.categorySet=function(t){o.catID=t,n.go("catalogue",{category:t})}})}];return{transclude:!0,restrict:"E",scope:{},controller:e,templateUrl:"templates/catMenu.html"}}]),catalogueModule.directive("productCard",function(){var t=["cartContainer",function(t){var e=this;e.addItem=function(e){var r={uid:e.uid,name:e.name,image:e.image,description:e.description,qty:1,price:e.price,categoryID:e.categoryID};t.addItem(r)}}];return{restrict:"E",scope:{product:"="},controller:t,controllerAs:"vm",bindToController:!0,templateUrl:"templates/productCard.html"}}),checkOutModule.directive("checkOut",function(){return{restrict:"E",scope:{},controller:"checkOutCtrl",controllerAs:"vm",bindToController:!0,templateUrl:"templates/checkOut.html"}});var checkOutCtrl=function(t,e,r,n){var a=this;a.totalCount=n.totalPrice(),a.cartList=n.readItems()};checkOutCtrl.$inject=["$translate","$translatePartialLoader","productsLoader","cartContainer"],checkOutModule.controller("checkOutCtrl",checkOutCtrl),checkOutModule.controller("checkoutConfirmModalCtrl",["$uibModalInstance",function(t){var e=this;e.ok=function(){t.close("success")},e.cancel=function(){t.dismiss("cancel")}}]);var itemPageCtrl=function(t,e,r,n,a,o,i){var c=a.category,u=a.item;o.maxQty=[1,2,3,4,5],n.getJSONCategories().then(function(e){for(var r,a=[],i=0;i<e.length;i++)e[i].id==c&&(a=e[i].http_request,r=e[i].name);a||t.go("catalogue"),n.getJSONProducts(a).then(function(e){for(var n=0;n<e.length;n++)e[n].uid==u&&(o.item=e[n]);o.item||t.go("catalogue"),o.item.categoryName=r,o.item.qty=1})}),o.addItem=function(t){var e={uid:t.uid,name:t.name,image:t.image,description:t.description,qty:t.qty,price:t.price,categoryID:t.categoryID};i.addItem(e)}};itemPageCtrl.$inject=["$state","$translate","$translatePartialLoader","productsLoader","$stateParams","$scope","cartContainer"],itemModule.controller("itemPageCtrl",itemPageCtrl),menuRootModule.directive("menuRoot",function(){var t=["$translate","$translatePartialLoader",function(t,e){e.addPart("MenuRoot"),this.changeLanguage=function(e){t.use(e)}}];return{restrict:"E",scope:{},controller:t,controllerAs:"menu",bindToController:!0,templateUrl:"templates/menuRoot.html"}}),funshopApp.factory("cartContainer",["$cookies",function(t){var e=[];t.get("localCart")&&(e=t.getObject("localCart"));var r={items:e,totalItems:function(){for(var t=0,e=0;e<this.items.length;e++)t+=parseInt(this.items[e].qty,10);return t},totalPrice:function(){for(var t=0,e=0;e<this.items.length;e++)t+=this.items[e].qty*this.items[e].price;return t},addItem:function(t){for(var e=!1,r=0;r<this.items.length;r++)this.items[r].uid==t.uid&&(this.items[r].qty+=t.qty,e=!0);e||(t.qty||(t.qty=1),t.description=t.description.slice(0,51),this.items.push(t))},minusItem:function(t){for(var e=0;e<this.items.length;e++)if(this.items[e].uid==t){var r=this.items[e].qty;this.items[e].qty=r-1,this.items[e].qty<1&&(this.items[e].qty=1)}},plusItem:function(t){for(var e=0;e<this.items.length;e++)if(this.items[e].uid==t){this.items[e].qty;this.items[e].qty++}},removeItemType:function(t){for(var e=0;e<this.items.length;e++)this.items[e].uid==t&&this.items.splice(e,1)}};return{addItem:function(e){r.addItem(e),t.putObject("localCart",r.items)},minusItem:function(e){r.minusItem(e),t.putObject("localCart",r.items)},plusItem:function(e){r.plusItem(e),t.putObject("localCart",r.items)},readItems:function(){return r.items},itemCount:function(){return r.totalItems()},totalPrice:function(){return r.totalPrice()},emptyCart:function(){r.items=[],t.remove("localCart")},removeItemType:function(e){r.removeItemType(e),t.putObject("localCart",r.items)}}}]),funshopApp.directive("imageLoadIndicator",function(){return{restrict:"E",scope:{src:"=imgSrc",width:"="},template:'<div class="img-loading-container"><div class="content-container"><div class="spinner"></div><img ng-src="{{src}}" width="{{width}}%" height="auto"></div></div>',link:function(t,e){e.find("img").on("load",function(){e.children().addClass("loaded")})}}}),funshopApp.directive("integerRestrict",function(){return{restrict:"A",scope:{},require:"ngModel",link:function(t,e,r,n){function a(t){if(t){var e=t.replace(o,"");return e!==t&&(n.$setViewValue(e),n.$render()),e=parseInt(e,10)}return n.$setViewValue("1"),n.$render(),1}var o=/[^0-9]*/g;n.$parsers.push(a)}}}),funshopApp.factory("productsLoader",["$http","$q",function(t,e){var r;return{getJSONProducts:function(r){var n=[],a=[],o=e.defer();if("[object Array]"===Object.prototype.toString.call(r))for(var i=0;i<r.length;i++)a[i]=t.get("data/"+r[i],[cache=!0]);else a.push(t.get("data/"+r,[cache=!0]));return e.all(a).then(function(t){for(var e=0;e<t.length;e++)for(var r=0;r<t[e].data.length;r++)t[e].data[r].price=parseInt(t[e].data[r].price,10),n.push(t[e].data[r]);o.resolve(n)},function(t){o.reject(t)},function(t){o.update(t)}),o.promise},getJSONCategories:function(){var n=e.defer();return r?(n.resolve(r),n.promise):(t.get("data/categories.json",[cache=!0]).then(function(t){r=t.data,n.resolve(r)},function(t){n.reject(t)},function(t){n.update(t)}),n.promise)}}}]),funshopApp.directive("stickyElm",["$window","$timeout",function(t,e){var r=function(e,r,n){function a(t){var e=0;do isNaN(t.offsetTop)||(e+=t.offsetTop);while(t=t.offsetParent);return e}function o(){m<=t.pageYOffset+u&&m>=0?(r.css({position:"fixed",top:u+"px",left:i,right:c,"z-index":s}),0==u?r.parent().parent().css("padding-top",r.initHeight+"px"):r.parent().css("padding-top",r.initHeight+"px")):(r.css({position:"relative",top:"0"}),0==u?r.parent().parent().css("padding-top","0"):r.parent().css("padding-top","0"))}var i,c,u=0,l=!0,s=10,d=angular.element(t),m=a(r[0]);if("sticky-elm"!=e.params&&"data-sticky-elm"!=e.params){var p=JSON.parse(e.params);u=parseInt(p.offset,10),l="true"==p.center,s=p.zIndex}r.initHeight=r[0].offsetHeight+parseInt(window.getComputedStyle(r[0]).marginBottom,10),l?(i=0,c=0):(i="auto",c="auto"),d.on("scroll",e.$apply.bind(e,o)),o()};return{restrict:"A",scope:{params:"@stickyElm"},link:r}}]);
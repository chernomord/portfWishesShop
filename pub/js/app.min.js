function unique(t,e){var r=t.slice(0);r.sort(function(t,r){return t[e].localeCompare(r[e])});for(var a=1;a<r.length;)r[a-1][e]==r[a][e]?r.splice(a,1):a++;return r}var bannerModule=angular.module("banner",[]),catalogueModule=angular.module("catalogueModule",[]),menuRootModule=angular.module("menuRootModule",[]),cartModule=angular.module("cartModule",[]),checkOutModule=angular.module("checkOutModule",[]),funshopApp=angular.module("funshopApp",["ngCookies","ui.router","ui.bootstrap","pascalprecht.translate","ngTagsInput","catalogueModule","banner","menuRootModule","cartModule","checkOutModule"]);funshopApp.config(["$translateProvider","$translatePartialLoaderProvider",function(t,e){t.registerAvailableLanguageKeys(["en","ru"],{"en_*":"en","ru_*":"ru"}).determinePreferredLanguage().fallbackLanguage("en").useCookieStorage().useLoader("$translatePartialLoader",{urlTemplate:"i18n/{part}/{lang}.json"}).useLoaderCache(!0).useSanitizeValueStrategy("escape"),e.addPart("Banner","MenuRoot","Catalogue")}]),funshopApp.run(["$rootScope","$translate",function(t,e){t.$on("$translatePartialLoaderStructureChanged",function(){e.refresh()})}]),funshopApp.config(["$stateProvider","$urlRouterProvider",function(t,e){e.otherwise("/catalogue"),t.state("catalogue",{url:"/catalogue",template:"<cat-menu><cat-content></cat-content></cat-menu>"}).state("catalogue.item",{url:"/item",template:"<p>item</p>"}).state("about",{url:"/about",templateUrl:"_templates/_about.html"}).state("cart",{url:"/cart",template:"<cart-list></cart-list>"}).state("checkOut",{url:"/cart/checkout",template:"<check-out></check-out>"}).state("checkOut.confirm",{url:"/confirm",onEnter:["$stateParams","$state","$uibModal","cartContainer",function(t,e,r,a){r.open({templateUrl:"_templates/_checkoutModal.html",controller:"checkoutConfirmModalCtrl",controllerAs:"vm",size:"sm",bindToController:!0}).result.then(function(){a.emptyCart(),e.go("catalogue")},function(){e.go("^")})}],onExit:function(){}})}]),bannerModule.directive("mainBanner",function(){return{restrict:"E",scope:{},templateUrl:"_templates/_banner.html"}}),cartModule.directive("cartBtn",function(){var t=["$scope","$translate","$translatePartialLoader","cartContainer",function(t,e,r,a){var n=this;n.productsCount=a.itemCount(),n.isDisabled=function(){return 0==n.productsCount},t.$watch(function(){return a.itemCount()},function(){n.productsCount=a.itemCount()},!0)}];return{restrict:"E",scope:{},controller:t,controllerAs:"vm",bindToController:!0,templateUrl:"_templates/_cartBtn.html"}}),cartModule.directive("cartList",function(){return{restrict:"E",scope:{},controller:"cartListCtrl",controllerAs:"vm",bindToController:!0,templateUrl:"_templates/_cartList.html"}});var cartListCtrl=function(t,e,r,a,n){var o=this;o.totalCount=n.totalPrice(),o.cartList=n.readItems(),o.removeItemType=function(t){n.removeItemType(t),o.updateCartModel()},o.minusItem=function(t){n.minusItem(t),o.updateCartModel()},o.plusItem=function(t){n.plusItem(t),o.updateCartModel()},o.emptyCart=function(){n.emptyCart(),o.updateCartModel(),t.go("catalogue")},o.updateCartModel=function(){o.totalCount=n.totalPrice(),o.cartList=n.readItems(),o.totalCount<1&&t.go("catalogue")}};cartListCtrl.$inject=["$state","$translate","$translatePartialLoader","productsLoader","cartContainer"],cartModule.controller("cartListCtrl",cartListCtrl);var ProductsLstCtrl=function(t,e,r,a){var n=this;n.catID=a.search().category,console.log(n.catID),this.$filter=e,this.$scope=t,this.productsLoader=r;var o={setDefaults:function(){this.name="",this.brand="",this.price={min:null,max:null},this.tags=null}};o.setDefaults(),r.getJSONProducts(["abstract.json","material.json"]).then(function(e){n.goodies=e,n.search=Object.create(o),n.categories=r.getCategories(),n.paginator={currentPage:1,maxSize:8,numPerPage:9,totalItems:n.goodies.length},n.updateProds(),t.$watch(function(){return[n.search.tags,n.search.price.min,n.search.price.max,n.search.name,n.search.brand]},function(){n.search.price.min<0&&(n.search.price.min=0),n.search.price.max<0&&(n.search.price.max=0),n.updateProds()},!0)})};ProductsLstCtrl.prototype.loadTags=function(t){for(var e=[],r=[],a=0;a<this.goodies.length;a++)e.push.apply(e,this.goodies[a].tags);for(e=unique(e,"text"),a=0;a<e.length;a++)-1!==e[a].text.indexOf(t)&&r.push(e[a]);return r},ProductsLstCtrl.prototype.resetFilter=function(){this.search.setDefaults()},ProductsLstCtrl.prototype.updateFilter=function(t,e,r){var a;a=this.$filter("filter")(t,{name:e.name,brand:e.brand}),a=this.$filter("byRange")(a,e.price,"price"),a=this.$filter("byTags")(a,e.tags,"tags"),r.totalItems=a.length;var n=(r.currentPage-1)*r.numPerPage,o=n+r.numPerPage;return a=a.slice(n,o)},ProductsLstCtrl.prototype.updateProds=function(){this.filteredGoodies=this.updateFilter(this.goodies,this.search,this.paginator)},ProductsLstCtrl.$inject=["$scope","$filter","productsLoader","$location"],catalogueModule.controller("ProductsLstCtrl",ProductsLstCtrl),catalogueModule.directive("catalogue",function(){return{restrict:"E",transclude:!0,scope:{catID:"@"},templateUrl:"_templates/_catalogue.html",controller:"ProductsLstCtrl",controllerAs:"vm",bindToController:!0}}),catalogueModule.filter("byRange",function(){return function(t,e,r){var a=[];if(void 0===e||null==e||null===e.min&&null===e.max)return t;if(void 0===e.min||null===e.min){if(0==e.max)return t;for(var n=0;n<t.length;n++)t[n][r]<=e.max&&a.push(t[n]);return a}if(void 0===e.max||null===e.max||0==e.max){for(n=0;n<t.length;n++)t[n][r]>=e.min&&a.push(t[n]);return a}for(n=0;n<t.length;n++)t[n][r]>=e.min&&t[n][r]<=e.max&&a.push(t[n]);return a}}),catalogueModule.filter("byTags",function(){return function(t,e,r){var a=[];if(e){for(var n=0;n<t.length;n++){for(var o=0,c=0;c<e.length;c++)for(var i=0;i<t[n][r].length;i++)t[n][r][i].text==e[c].text&&o++;o==e.length&&a.push(t[n])}return a}return t}}),catalogueModule.filter("myUnique",function(){return function(t,e){if(!t||!e)return!1;for(var r=unique(t,e),a=[],n=0;n<r.length;n++)a.push(r[n]);return a}}),catalogueModule.directive("catContent",function(){var t=["productsLoader","$scope","$filter",function(t,e,r){var a=this,n={setDefaults:function(){this.name="",this.brand="",this.price={min:null,max:null},this.tags=null}};n.setDefaults(),e.$watch(function(){return a.requests},function(){a.requests&&t.getJSONProducts(a.requests).then(function(t){a.goodies=t,a.search=Object.create(n),a.paginator={currentPage:1,maxSize:8,numPerPage:9,totalItems:a.goodies.length},a.updateProds(),e.$watch(function(){return[a.search.tags,a.search.price.min,a.search.price.max,a.search.name,a.search.brand]},function(){a.search.price.min<0&&(a.search.price.min=0),a.search.price.max<0&&(a.search.price.max=0),a.updateProds()},!0)})},!0),a.loadTags=function(t){for(var e=[],r=[],a=0;a<this.goodies.length;a++)e.push.apply(e,this.goodies[a].tags);for(e=unique(e,"text"),a=0;a<e.length;a++)-1!==e[a].text.indexOf(t)&&r.push(e[a]);return r},a.resetFilter=function(){a.search.setDefaults()},a.updateFilter=function(t,e,a){var n;n=r("filter")(t,{name:e.name,brand:e.brand}),n=r("byRange")(n,e.price,"price"),n=r("byTags")(n,e.tags,"tags"),a.totalItems=n.length;var o=(a.currentPage-1)*a.numPerPage,c=o+a.numPerPage;return n=n.slice(o,c)},a.updateProds=function(){a.filteredGoodies=a.updateFilter(a.goodies,a.search,a.paginator)}}];return{restrict:"E",scope:{requests:"=requests",categories:"=categories"},require:"^catMenu",controller:t,controllerAs:"vm",bindToController:!0,templateUrl:"_templates/_catContent.html"}}),catalogueModule.directive("catMenu",["$timeout","$location",function(t,e){var r=e.search(),a="all",n=["$q","cartContainer","productsLoader","$scope",function(t,e,r,n){var o=this;n.catID=a,r.getJSONCategories().then(function(t){o.categories=t,n.setRequests=function(e){for(var r=[],a=0;a<t.length;a++)(t[a].id==e||"all"==e)&&r.push(t[a].http_request);return r}}),o.categorySet=function(t){n.catID=t,n.requests=n.setRequests(t)}}],o=function(n,o,c){o.find("ul").on("click",function(t){var r=angular.element(t.target),a=r.attr("data-cat-id");n.$apply(function(){e.search("category",a)}),r.parent().parent().children().removeClass("active"),r.parent().addClass("active")}),n.$watch("vm.categories",function(c,i){if(c){var u=o.find("a");t(function(){r.category&&r.category<u.length?(a=r.category,n.catID=r.category,n.requests=n.setRequests(a)):(a="all",n.catID="all",n.requests=n.setRequests(a));for(var t=0;t<u.length;t++){var o=angular.element(u[t]);u.eq(t).attr("data-cat-id")==a&&(n.$apply(function(){e.search("category",o.attr("data-cat-id"))}),u.eq(t).parent().addClass("active"))}})}})};return{transclude:!0,restrict:"E",scope:{},controller:n,controllerAs:"vm",bindToController:!0,link:o,templateUrl:"_templates/_catMenu.html"}}]),catalogueModule.directive("productCard",function(){var t=["cartContainer",function(t){var e=this;e.addItem=function(e){var r={uid:e.uid,name:e.name,description:e.description,qty:1,price:e.price};t.addItem(r)}}];return{restrict:"E",scope:{product:"="},controller:t,controllerAs:"vm",bindToController:!0,templateUrl:"_templates/_productCard.html"}}),checkOutModule.directive("checkOut",function(){return{restrict:"E",scope:{},controller:"checkOutCtrl",controllerAs:"vm",bindToController:!0,templateUrl:"_templates/_checkOut.html"}});var checkOutCtrl=function(t,e,r,a){var n=this;n.totalCount=a.totalPrice(),n.cartList=a.readItems()};checkOutCtrl.$inject=["$translate","$translatePartialLoader","productsLoader","cartContainer"],checkOutModule.controller("checkOutCtrl",checkOutCtrl),checkOutModule.controller("checkoutConfirmModalCtrl",["$uibModalInstance",function(t){var e=this;e.ok=function(){t.close("success")},e.cancel=function(){t.dismiss("cancel")}}]),menuRootModule.directive("menuRoot",function(){var t=["$translate","$translatePartialLoader",function(t,e){e.addPart("MenuRoot"),this.changeLanguage=function(e){t.use(e)}}];return{restrict:"E",scope:{},controller:t,controllerAs:"menu",bindToController:!0,templateUrl:"_templates/_menuRoot.html"}}),funshopApp.factory("cartContainer",["$cookies",function(t){var e=[];t.get("localCart")&&(e=t.getObject("localCart"));var r={items:e,totalItems:function(){for(var t=0,e=0;e<this.items.length;e++)t+=parseInt(this.items[e].qty,10);return t},totalPrice:function(){for(var t=0,e=0;e<this.items.length;e++)t+=this.items[e].qty*this.items[e].price;return t},addItem:function(t){for(var e=!1,r=0;r<this.items.length;r++)this.items[r].uid==t.uid&&(this.items[r].qty+=t.qty,e=!0);e||(t.qty=1,this.items.push(t))},minusItem:function(t){for(var e=0;e<this.items.length;e++)if(this.items[e].uid==t){var r=this.items[e].qty;this.items[e].qty=r-1,this.items[e].qty<1&&this.items.splice(e,1)}},plusItem:function(t){for(var e=0;e<this.items.length;e++)if(this.items[e].uid==t){this.items[e].qty;this.items[e].qty++}},removeItemType:function(t){for(var e=0;e<this.items.length;e++)this.items[e].uid==t&&this.items.splice(e,1)}};return{addItem:function(e){r.addItem(e),t.putObject("localCart",r.items)},minusItem:function(e){r.minusItem(e),t.putObject("localCart",r.items)},plusItem:function(e){r.plusItem(e),t.putObject("localCart",r.items)},readItems:function(){return r.items},itemCount:function(){return r.totalItems()},totalPrice:function(){return r.totalPrice()},emptyCart:function(){r.items=[],t.remove("localCart")},removeItemType:function(e){r.removeItemType(e),t.putObject("localCart",r.items)}}}]),funshopApp.factory("productsLoader",["$http","$q",function(t,e){return{getJSONProducts:function(r){for(var a=[],n=[],o=e.defer(),c=0;c<r.length;c++)n[c]=t.get("data/"+r[c],[cache=!0]);return e.all(n).then(function(t){for(var e=0;e<t.length;e++)for(var r=0;r<t[e].data.length;r++)a.push(t[e].data[r]);o.resolve(a)},function(t){o.reject(t)},function(t){o.update(t)}),o.promise},getJSONCategories:function(){var r=e.defer();return t.get("data/categories.json",[cache=!0]).then(function(t){r.resolve(t.data)},function(t){r.reject(t)},function(t){r.update(t)}),r.promise}}}]);